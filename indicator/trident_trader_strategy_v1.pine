// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TridentTrader

//@version=5
strategy("Trident Trader Strategy v1", overlay=true, initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.04, pyramiding=0, calc_on_order_fills=true, calc_on_every_tick=false)

// Minimal strategy using core Trident PRO gates (simplified for backtests)

// Inputs (subset)
mode = input.string("Balanced", "Mode", options=["Scalping","Balanced","Swing"])
trendMethod = input.string("Supertrend", "Trend Method", options=["Supertrend","EMA Cross","ADX"]) 
stLen = input.int(10, "ST Length")
stMult = input.float(3.0, "ST Mult")
emaFast = input.int(20, "Fast EMA")
emaSlow = input.int(50, "Slow EMA")
adxLen = input.int(14, "ADX Length")
adxGate = input.int(20, "Min ADX")

momMethod = input.string("Composite", "Momentum", options=["RSI","MACD","Stochastic","Composite"]) 
rsiLen = input.int(14, "RSI Len")
rsiOB = input.int(70, "RSI OB")
rsiOS = input.int(30, "RSI OS")
macdFast = input.int(12, "MACD Fast")
macdSlow = input.int(26, "MACD Slow")
macdSignal = input.int(9, "MACD Signal")
stochLen = input.int(14, "Stoch Len")
stochSmooth = input.int(3, "Stoch Smooth")

atrLen = input.int(14, "ATR Len")
slATR = input.float(1.5, "SL (ATR x)")
tp1ATR = input.float(2.0, "TP1 (ATR x)")
tp2ATR = input.float(3.5, "TP2 (ATR x)")
trailATR = input.float(1.0, "Trail (ATR x)")
useTrail = input.bool(true, "Use Trailing")

useHTF = input.bool(true, "Use HTF Confirm")
htf = input.timeframe("60", "Higher TF")

modeMult = mode == "Scalping" ? 0.7 : mode == "Swing" ? 1.3 : 1.0

// Trend
[stLine, _] = ta.supertrend(stMult, int(math.max(1, math.round(stLen * modeMult))))
stBull = close > stLine
stBear = close < stLine
emaF = ta.ema(close, emaFast)
emaS = ta.ema(close, emaSlow)
emaBull = emaF > emaS
emaBear = emaF < emaS
[dip, dim, adx] = ta.dmi(adxLen, adxLen)
adxBull = dip > dim and adx >= adxGate
adxBear = dim > dip and adx >= adxGate
trendBull = trendMethod == "Supertrend" ? stBull : trendMethod == "EMA Cross" ? emaBull : adxBull
trendBear = trendMethod == "Supertrend" ? stBear : trendMethod == "EMA Cross" ? emaBear : adxBear
htfBull = useHTF ? request.security(syminfo.tickerid, htf, trendBull, barmerge.gaps_off, barmerge.lookahead_off) : true
htfBear = useHTF ? request.security(syminfo.tickerid, htf, trendBear, barmerge.gaps_off, barmerge.lookahead_off) : true

// Momentum
rsi = ta.rsi(close, rsiLen)
rsiBull = rsi > 50 and rsi > rsi[1]
rsiBear = rsi < 50 and rsi < rsi[1]
[macdL, macdS, macdH] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdBull = macdL > macdS and macdH > macdH[1]
macdBear = macdL < macdS and macdH < macdH[1]
k = ta.stoch(close, high, low, stochLen)
d = ta.sma(k, stochSmooth)
stBull = k > d and k > k[1]
stBear = k < d and k < k[1]
momBullComp = rsiBull or macdBull or stBull
momBearComp = rsiBear or macdBear or stBear
momBull = momMethod == "RSI" ? rsiBull : momMethod == "MACD" ? macdBull : momMethod == "Stochastic" ? stBull : momBullComp
momBear = momMethod == "RSI" ? rsiBear : momMethod == "MACD" ? macdBear : momMethod == "Stochastic" ? stBear : momBearComp

// Volatility filter
atr = ta.atr(atrLen)
atrSma = ta.sma(atr, 100)
volOk = atr > 0 and (atrSma == 0 or atr > 0.7 * atrSma)

// Gates
bullGate = trendBull and htfBull and momBull and adx >= adxGate and volOk
bearGate = trendBear and htfBear and momBear and adx >= adxGate and volOk

// Orders
longSL = close - atr * slATR
longTP = close + atr * tp1ATR
longTP2 = close + atr * tp2ATR
shortSL = close + atr * slATR
shortTP = close - atr * tp1ATR
shortTP2 = close - atr * tp2ATR

if bullGate and strategy.position_size <= 0
    strategy.entry("Long", strategy.long)
    if useTrail
        strategy.exit("L-Exit", "Long", stop=na, trail_points=atr * trailATR / syminfo.mintick)
    else
        strategy.exit("L-Exit", "Long", stop=longSL, limit=longTP)

if bearGate and strategy.position_size >= 0
    strategy.entry("Short", strategy.short)
    if useTrail
        strategy.exit("S-Exit", "Short", stop=na, trail_points=atr * trailATR / syminfo.mintick)
    else
        strategy.exit("S-Exit", "Short", stop=shortSL, limit=shortTP)

plotshape(bullGate, title="BullGate", style=shape.circle, location=location.belowbar, color=color.new(color.lime, 60), size=size.tiny)
plotshape(bearGate, title="BearGate", style=shape.circle, location=location.abovebar, color=color.new(color.red, 60), size=size.tiny) 
